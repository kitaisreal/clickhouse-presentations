<!DOCTYPE html>
<html lang="en">
<head>
    <title>YDB ARM Performance Optimizations 2</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="shower/themes/yandex/styles/screen-16x9.css">

    <style type="text/css">
        code { display: block; white-space: pre; background-color: #EEE; }
        p.cloud { text-align: center; line-height: 1.5; }
        p.cloud span { font-size: 13pt; color: gray; padding: 0 20px 0 20px; white-space: nowrap; }
   </style>
</head>
<body class="shower list">
    <header class="caption">
        <h1>YDB ARM Performance Optimizations 2</h1>
    </header>

    <section class="slide" id="cover">
        <h1 style="margin-top: 150px;">YDB ARM Performance Optimizations 2</h1>
    </section>

    <section class="slide">
        <h2>ARM Cluster</h2>

        <p>9 nodes</p>
        <p>CPU: Kunpeng 920-4826 (96 physical cores).</p>
        <p>RAM: 502GB.</p>
        <p>Disk: SSD SAMSUNG MZ7LH960 (Sequential write around 500 MB/s, read around 500 MB/s).</p>
    </section>

    <section class="slide">
        <h2>X86-64 Cluster</h2>

        <p>9 nodes</p>
        <p>CPU: Intel(R) Xeon(R) Gold 6126 (24 physical cores, 48 cores with hyper-threading).</p>
        <p>RAM: 375GB.</p>
        <p>Disk: SSD SDLF1CRM016T-1HH.</p>
    </section>

    <section class="slide">
        <h2>YDB Configuration</h2>

        <p>YDB configuration: 1 storage node, 4 dynamic nodes (standard configuration for large servers).</p>
    </section>

    <section class="slide">
        <h2>Benchmarks</h2>

        <p>Benchmarks:</p>
        <p>1. ClickBench.</p>
        <p>2. YCSB.</p>
        <p>3. TPC-C.</p>
    </section>

    <section class="slide">
        <h2>ClickBench</h2>

        <p>ClickBench <a href="https://github.com/ClickHouse/ClickBench">https://github.com/ClickHouse/ClickBench</a></p></p>
        <p>Data is based on obfuscated data from Yandex.Metrica production.</p>
        <p>Dataset contains 100m rows, 70GB uncompressed data.</p>
        <p>Queries mostly analytical, but some contain unindexed key lookups:</p>
        <code style="font-size: 16pt;">SELECT UserID FROM hits WHERE UserID = 435090932899640449;</code>
        <p></p>
        <p>Main goal is to utilize and stress test system under pressure, to find some hotspots that can be optimized.</p>
    </section>

    <section class="slide">
        <h2>ClickBench</h2>

        <p>ARM upload time: 954 seconds.</p>
        <p>X86 upload time: 1440 seconds.</p>

        <p>ARM 50% faster.</p>
    </section>

    <section class="slide">
        <h2>ClickBench</h2>

        <img style="width: 85%;" src="pictures/arm_x86_cluster_hits_full.png"/>
    </section>

    <section class="slide">
        <h2>ClickBench</h2>

        <code style="font-size: 14pt;">SELECT SUM(ResolutionWidth), SUM(ResolutionWidth + 1),
    SUM(ResolutionWidth + 2), SUM(ResolutionWidth + 3),
    SUM(ResolutionWidth + 4), SUM(ResolutionWidth + 5),
    SUM(ResolutionWidth + 6), SUM(ResolutionWidth + 7),
    SUM(ResolutionWidth + 8), SUM(ResolutionWidth + 9),
    SUM(ResolutionWidth + 10), SUM(ResolutionWidth + 11),
    SUM(ResolutionWidth + 12), SUM(ResolutionWidth + 13),
    SUM(ResolutionWidth + 14), SUM(ResolutionWidth + 15),
    ...
    SUM(ResolutionWidth + 87), SUM(ResolutionWidth + 88),
    SUM(ResolutionWidth + 89) FROM hits;</code>

        <br>

        <p>ARM: 31 seconds.</p>
        <p>X86: 71 seconds.</p>
</code>
    </section>

    <section class="slide">
        <h2>ClickBench</h2>

        <p>Overall ARM is faster in 15-25%.</p>
    </section>

    <section class="slide">
        <h2>YCSB</h2>

        <p>Yahoo! Cloud Serving Benchmark.</p>
        <p>Several different key-value workloads.</p>
        <p>Each workload can be parameterized using record count, threads and target queries for each thread.</p>
        <p>Zipfian distribution.</p>

        <p><a href="https://github.com/brianfrankcooper/YCSB">https://github.com/brianfrankcooper/YCSB</a></p></p>
        <p><a href="https://courses.cs.duke.edu/fall13/compsci590.4/838-CloudPapers/ycsb.pdf">Benchmarking Cloud Serving Systems with YCSB</a></p></p>
        <p><a href="https://en.wikipedia.org/wiki/Zipf%27s_law">Zipfian distribution</a></p></p>
    </section>

    <section class="slide">
        <h2>YCSB workloads</h2>

        <p>Workload A: Update heavy workload (50/50 reads/writes).</p>
        <p>Workload B: Read mostly workload (95/5 reads/writes).</p>
        <p>Workload C: Read only.</p>
        <p>Workload D: Read latest (insert new record and read inserted).</p>
        <p>Workload E: Read ranges.</p>
        <p>Workload F: Read-modify-write (read record modify it and write).</p>
    </section>

    <section class="slide">
        <h2>YCSB</h2>

        <p>Datasets: 10M (10 GB), 100M (100 GB), 300M (300 Gb).</p>
        <p>Workloads: A, B, C, D, E, F.</p>
        <p>Threads: 1, 64, 128, 256, 512, 1024.</p>
    </section>

    <section class="slide">
        <h2>YCSB</h2>

        <p>ARM 10m, 100m, 300m upload time: 107, 1311, 3945 seconds.</p>
        <p>X86 10m, 100m, 300m upload time: 148, 1839, 6750 seconds.</p>

        <p>Almost linear scaling with increased amount of data.</p>
        <p>ARM is 30-50% faster.</p>
    </section>

    <section class="slide">
        <h2>YCSB 10m</h2>

        <code style="font-size: 20pt;">ydb -p test_db_cluster scheme describe usertable
--stats --partition-stats --permissions</code>

        <p></p>

        <code style="font-size: 16pt;">Table stats:
Partitions count: 50
Approximate number of rows: 10000000
Approximate size of table: 10.65 Gb</code>
    </section>

    <section class="slide">
        <h2>YCSB 10m A</h2>

        <img style="width: 85%;" src="pictures/ycsb_10m_workload_A.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 10m B</h2>

        <img style="width: 85%;" src="pictures/ycsb_10m_workload_B.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 10m C</h2>

        <img style="width: 85%;" src="pictures/ycsb_10m_workload_C.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 10m E</h2>

        <img style="width: 85%;" src="pictures/ycsb_10m_workload_E.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 10m F</h2>

        <img style="width: 85%;" src="pictures/ycsb_10m_workload_F.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 10m</h2>

        <img style="width: 85%;" src="pictures/ycsb_10m.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 100m</h2>

        <code style="font-size: 20pt;">ydb -p test_db_cluster scheme describe usertable
--stats --partition-stats --permissions</code>

        <p></p>

        <code style="font-size: 16pt;">Table stats:
Partitions count: 80
Approximate number of rows: 100000000
Approximate size of table: 106.14 Gb</code>
    </section>

    <section class="slide">
        <h2>YCSB 100m A</h2>

        <img style="width: 85%;" src="pictures/ycsb_100m_workload_A.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 100m B</h2>

        <img style="width: 85%;" src="pictures/ycsb_100m_workload_B.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 100m C</h2>

        <img style="width: 85%;" src="pictures/ycsb_100m_workload_C.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 100m E</h2>

        <img style="width: 85%;" src="pictures/ycsb_100m_workload_E.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 100m F</h2>

        <img style="width: 85%;" src="pictures/ycsb_100m_workload_F.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 100m</h2>

        <img style="width: 85%;" src="pictures/ycsb_100m.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 300m</h2>

        <code style="font-size: 20pt;">ydb -p test_db_cluster scheme describe usertable
--stats --partition-stats --permissions</code>

        <p></p>

        <code style="font-size: 16pt;">Table stats:
Partitions count: 229
Approximate number of rows: 300000400
Approximate size of table: 318.61 Gb</code>
    </section>

    <section class="slide">
        <h2>YCSB 300m A</h2>

        <img style="width: 85%;" src="pictures/ycsb_300m_workload_A.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 300m B</h2>

        <img style="width: 85%;" src="pictures/ycsb_300m_workload_B.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 300m C</h2>

        <img style="width: 85%;" src="pictures/ycsb_300m_workload_C.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 300m E</h2>

        <img style="width: 85%;" src="pictures/ycsb_300m_workload_E.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 300m F</h2>

        <img style="width: 85%;" src="pictures/ycsb_300m_workload_F.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 300m</h2>

        <img style="width: 85%;" src="pictures/ycsb_300m.png"/>
    </section>

    <section class="slide">
        <h2>YCSB 300m</h2>

        <p>Throughput increases with increase of data size because of partitioning.</p>
        <p>ARM does not have any scalability issues, only CPU underutilization.</p>
    </section>

    <section class="slide">
        <h2>YCSB ARM data upload</h2>

        <p>Vectorize ChaCha encryption.</p>
        <p>Optimize XXH3 hash implementation.</p>
    </section>

    <section class="slide">
        <h2>YCSB ARM Workload A Flame Graph</h2>

        <img style="width: 100%;" src="pictures/ycsb_arm_100m_workload_a_framegraph.png"/>
    </section>

    <section class="slide">
        <h2>YCSB ARM Workload A Flame Graph</h2>

        <img style="width: 100%;" src="pictures/ycsb_arm_100m_workload_a_actor_system_flamegraph.png"/>
    </section>

    <section class="slide">
        <h2>TPC-C</h2>

        <p>Industry standard benchmark for OLTP databases.</p>
        <p>Complex schema for wholesale supplier database.</p>
        <p>Can be parameterized only with warehouse count.</p>
        <p>Each transaction can access multiple table with complex access patterns.</p>
        <p><a href="https://www.tpc.org/tpc_documents_current_versions/pdf/tpc-c_v5.11.0.pdf">TPC-C standard</a></p>
    </section>

    <section class="slide">
        <h2>TPC-C</h2>

        <img style="width: 85%;" src="pictures/tpcc_schema.png"/>
    </section>

    <section class="slide">
        <h2>TPC-C</h2>

        <p>TPM-C - NewOrder transactions per second.</p>
        <p>Efficiency - TPM-C / Maximum possible TPM-C.</p>
        <p>Latency numbers for each transaction type.</p>
    </section>

    <section class="slide">
        <h2>TPC-C</h2>

        <p>ARM 1000, 2500 warehouses upload time: 592, 1361 seconds.</p>
        <p>X86 1000, 2500 warehouses upload time: 1860, 2591 seconds.</p>
    </section>

    <section class="slide">
        <h2>TPC-C</h2>

        <p>ARM</p>
        <p>1000 warehouses TPM-C 12186.</p>
        <p>2500 warehouses TPM-C 24510.</p>

        <p>X86</p>
        <p>1000 warehouses TPM-C 12093.</p>
        <p>2500 warehouses TPM-C 23910.</p>

        <p>In all cases efficiency higher than 97%.</p>
    </section>

    <section class="slide">
        <h2>Questions?</h2>
    </section>

    <div class="progress"></div>
    <script src="shower/shower.min.js"></script>

    <!--Video plugin-->
    <link rel="stylesheet" href="shower/shower-video.css">
    <script src="shower/shower-video.js"></script>
    <!--/Video plugin-->
</body>
</html>
